-- ============================================
-- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–†–ï–î–ú–ï–¢–û–í –° –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò –°–¢–ê–¢–ê–ú–ò
-- ============================================
-- –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ–¥ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∏–∑ 10 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫

-- –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã items –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–æ–≤
ALTER TABLE items 
DROP COLUMN IF EXISTS strength_bonus,
DROP COLUMN IF EXISTS dexterity_bonus,
DROP COLUMN IF EXISTS intelligence_bonus,
DROP COLUMN IF EXISTS vitality_bonus,
DROP COLUMN IF EXISTS energy_bonus,
DROP COLUMN IF EXISTS luck_bonus;

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è 10 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
ALTER TABLE items 
ADD COLUMN IF NOT EXISTS agility_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS precision_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS evasion_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS intelligence_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS spell_power_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS resistance_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS strength_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS endurance_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS armor_bonus INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS stealth_bonus INTEGER DEFAULT 0;

-- –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
DELETE FROM items;

-- –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—Ç–∞—Ç–∞–º–∏
INSERT INTO items (
    name, description, item_type, slot, rarity, level_requirement,
    agility_bonus, precision_bonus, evasion_bonus, intelligence_bonus, spell_power_bonus, resistance_bonus,
    strength_bonus, endurance_bonus, armor_bonus, stealth_bonus,
    attack_damage, defense, vendor_price, stack_size, icon
) VALUES 

-- ============================================
-- –û–†–£–ñ–ò–ï –î–õ–Ø –õ–£–ß–ù–ò–ö–ê
-- ============================================
('–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –ª—É–∫', '–ü—Ä–æ—Å—Ç–æ–π –ª—É–∫ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –ª—É—á–Ω–∏–∫–æ–≤', 'weapon', 'weapon', 'common', 1,
    3, 2, 1, 0, 0, 0, 0, 0, 0, 0, 15, 0, 60, 1, 'üèπ'),

('–û—Ö–æ—Ç–Ω–∏—á–∏–π –ª—É–∫', '–ù–∞–¥–µ–∂–Ω—ã–π –ª—É–∫ –¥–ª—è –æ—Ö–æ—Ç—ã', 'weapon', 'weapon', 'uncommon', 5,
    5, 4, 2, 0, 0, 0, 0, 0, 0, 0, 25, 0, 150, 1, 'üèπ'),

('–≠–ª—å—Ñ–∏–π—Å–∫–∏–π –ª—É–∫', '–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –ª—É–∫ —ç–ª—å—Ñ–∏–π—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã', 'weapon', 'weapon', 'rare', 15,
    8, 6, 4, 2, 0, 2, 0, 0, 0, 1, 40, 0, 400, 1, 'üèπ'),

('–õ—É–Ω–Ω—ã–π –ª—É–∫', '–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ª—É–∫, —Å–≤–µ—Ç—è—â–∏–π—Å—è –ª—É–Ω–Ω—ã–º —Å–≤–µ—Ç–æ–º', 'weapon', 'weapon', 'epic', 30,
    12, 10, 6, 4, 3, 4, 0, 0, 0, 3, 65, 0, 800, 1, 'üåô'),

-- ============================================
-- –û–†–£–ñ–ò–ï –î–õ–Ø –ú–ê–ì–ê
-- ============================================
('–ü–æ—Å–æ—Ö –Ω–æ–≤–∏—á–∫–∞', '–ü—Ä–æ—Å—Ç–æ–π –ø–æ—Å–æ—Ö –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –º–∞–≥–æ–≤', 'weapon', 'weapon', 'common', 1,
    0, 1, 0, 3, 2, 1, 0, 0, 0, 0, 8, 0, 70, 1, 'ü™Ñ'),

('–ú–∞–≥–∏—á–µ—Å–∫–∏–π –∂–µ–∑–ª', '–ñ–µ–∑–ª —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞–º–∏', 'weapon', 'weapon', 'uncommon', 8,
    1, 2, 1, 5, 4, 3, 0, 0, 0, 0, 15, 0, 200, 1, 'üîÆ'),

('–ü–æ—Å–æ—Ö –∞—Ä—Ö–∏–º–∞–≥–∞', '–ú–æ—â–Ω—ã–π –ø–æ—Å–æ—Ö –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –º–∞–≥–æ–≤', 'weapon', 'weapon', 'rare', 20,
    2, 3, 2, 8, 7, 6, 0, 0, 0, 1, 30, 0, 600, 1, 'üßô‚Äç‚ôÇÔ∏è'),

('–ñ–µ–∑–ª –¥—Ä–∞–∫–æ–Ω–∞', '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∂–µ–∑–ª –∏–∑ –¥—Ä–∞–∫–æ–Ω—å–µ–π –∫–æ—Å—Ç–∏', 'weapon', 'weapon', 'epic', 40,
    3, 4, 3, 12, 10, 8, 0, 0, 0, 2, 50, 0, 1200, 1, 'üêâ'),

-- ============================================
-- –û–†–£–ñ–ò–ï –î–õ–Ø –ë–ï–†–°–ï–†–ö–ê
-- ============================================
('–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Ç–æ–ø–æ—Ä', '–ü—Ä–æ—Å—Ç–æ–π —Ç–æ–ø–æ—Ä –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –≤–æ–∏–Ω–æ–≤', 'weapon', 'weapon', 'common', 1,
    1, 0, 0, 0, 0, 0, 4, 2, 1, 0, 20, 0, 80, 1, 'ü™ì'),

('–°—Ç–∞–ª—å–Ω–æ–π —Ç–æ–ø–æ—Ä', '–¢—è–∂–µ–ª—ã–π —Ç–æ–ø–æ—Ä –∏–∑ –∑–∞–∫–∞–ª–µ–Ω–Ω–æ–π —Å—Ç–∞–ª–∏', 'weapon', 'weapon', 'uncommon', 10,
    2, 1, 0, 0, 0, 0, 8, 5, 3, 0, 40, 0, 300, 1, '‚öîÔ∏è'),

('–ë–æ–µ–≤–æ–π –º–æ–ª–æ—Ç', '–ú–æ—â–Ω—ã–π –º–æ–ª–æ—Ç –¥–ª—è –±–ª–∏–∂–Ω–µ–≥–æ –±–æ—è', 'weapon', 'weapon', 'rare', 25,
    3, 2, 1, 0, 0, 0, 12, 8, 5, 0, 70, 0, 700, 1, 'üî®'),

('–î—Ä–∞–∫–æ–Ω–∏–π —Ç–æ–ø–æ—Ä', '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Ç–æ–ø–æ—Ä –∏–∑ –¥—Ä–∞–∫–æ–Ω—å–∏—Ö –∑—É–±–æ–≤', 'weapon', 'weapon', 'epic', 45,
    5, 3, 2, 0, 0, 0, 18, 12, 8, 0, 110, 0, 1500, 1, 'üê≤'),

-- ============================================
-- –û–†–£–ñ–ò–ï –î–õ–Ø –ê–°–°–ê–°–ò–ù–ê
-- ============================================
('–ö–∏–Ω–∂–∞–ª –Ω–æ–≤–∏—á–∫–∞', '–ü—Ä–æ—Å—Ç–æ–π –∫–∏–Ω–∂–∞–ª –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —É–±–∏–π—Ü', 'weapon', 'weapon', 'common', 1,
    2, 1, 1, 0, 0, 0, 1, 0, 0, 3, 12, 0, 90, 1, 'üó°Ô∏è'),

('–ö–æ–≥—Ç–∏ —Ç–µ–Ω–µ–π', '–û—Å—Ç—Ä—ã–µ –∫–æ–≥—Ç–∏, –ø–æ–∫—Ä—ã—Ç—ã–µ —Ç–µ–Ω—å—é', 'weapon', 'weapon', 'uncommon', 12,
    4, 3, 3, 1, 0, 0, 2, 1, 0, 6, 25, 0, 350, 1, 'üñ§'),

('–ö–ª–∏–Ω–∫–∏ —É–±–∏–π—Ü—ã', '–ü–∞—Ä–∞ –∑–∞—Ç–æ—á–µ–Ω–Ω—ã—Ö –∫–ª–∏–Ω–∫–æ–≤ —É–±–∏–π—Ü—ã', 'weapon', 'weapon', 'rare', 28,
    6, 5, 5, 2, 0, 1, 3, 2, 0, 10, 45, 0, 800, 1, '‚öîÔ∏è'),

('–ö–æ–≥—Ç–∏ –¥—Ä–∞–∫–æ–Ω–∞', '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –∫–æ–≥—Ç–∏ –∏–∑ –¥—Ä–∞–∫–æ–Ω—å–∏—Ö –∫–æ–≥—Ç–µ–π', 'weapon', 'weapon', 'epic', 50,
    10, 8, 8, 3, 0, 2, 5, 3, 0, 15, 80, 0, 1800, 1, 'üêâ'),

-- ============================================
-- –ë–†–û–ù–Ø –î–õ–Ø –í–°–ï–• –ö–õ–ê–°–°–û–í
-- ============================================
-- –õ–µ–≥–∫–∞—è –±—Ä–æ–Ω—è (–ª—É—á–Ω–∏–∫, –∞—Å—Å–∞—Å–∏–Ω)
('–ö–æ–∂–∞–Ω–∞—è –∫—É—Ä—Ç–∫–∞', '–õ–µ–≥–∫–∞—è –±—Ä–æ–Ω—è –∏–∑ –∫–æ–∂–∏', 'armor', 'chest', 'common', 1,
    2, 1, 2, 0, 0, 0, 0, 1, 3, 1, 0, 8, 100, 1, 'ü¶∫'),

('–ö–æ–∂–∞–Ω—ã–µ —à—Ç–∞–Ω—ã', '–£–¥–æ–±–Ω—ã–µ —à—Ç–∞–Ω—ã –∏–∑ –∫–æ–∂–∏', 'armor', 'legs', 'common', 1,
    1, 1, 1, 0, 0, 0, 0, 1, 2, 0, 0, 5, 60, 1, 'üëñ'),

('–ö–æ–∂–∞–Ω—ã–µ —Å–∞–ø–æ–≥–∏', '–õ–µ–≥–∫–∏–µ —Å–∞–ø–æ–≥–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è', 'armor', 'boots', 'common', 1,
    2, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 3, 40, 1, 'ü•æ'),

-- –°—Ä–µ–¥–Ω—è—è –±—Ä–æ–Ω—è (–º–∞–≥)
('–ú–∞–≥–∏—á–µ—Å–∫–∞—è –º–∞–Ω—Ç–∏—è', '–ú–∞–Ω—Ç–∏—è, —É—Å–∏–ª–∏–≤–∞—é—â–∞—è –º–∞–≥–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏', 'armor', 'chest', 'common', 1,
    0, 1, 1, 2, 1, 2, 0, 0, 2, 0, 0, 6, 120, 1, 'üßô‚Äç‚ôÇÔ∏è'),

('–ú–∞–≥–∏—á–µ—Å–∫–∏–µ —à—Ç–∞–Ω—ã', '–®—Ç–∞–Ω—ã —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ —Ä—É–Ω–∞–º–∏', 'armor', 'legs', 'common', 1,
    0, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 4, 80, 1, 'üëñ'),

('–ú–∞–≥–∏—á–µ—Å–∫–∏–µ —Å–∞–ø–æ–≥–∏', '–°–∞–ø–æ–≥–∏ —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ —á–∞—Ä–∞–º–∏', 'armor', 'boots', 'common', 1,
    1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 3, 50, 1, 'üë¢'),

-- –¢—è–∂–µ–ª–∞—è –±—Ä–æ–Ω—è (–±–µ—Ä—Å–µ—Ä–∫)
('–ö–æ–ª—å—á—É–∂–Ω–∞—è —Ä—É–±–∞—Ö–∞', '–ü—Ä–æ—á–Ω–∞—è –∫–æ–ª—å—á—É–∂–Ω–∞—è –±—Ä–æ–Ω—è', 'armor', 'chest', 'common', 1,
    0, 0, 0, 0, 0, 0, 3, 2, 8, 0, 0, 15, 150, 1, 'üõ°Ô∏è'),

('–ö–æ–ª—å—á—É–∂–Ω—ã–µ —à—Ç–∞–Ω—ã', '–¢—è–∂–µ–ª—ã–µ —à—Ç–∞–Ω—ã –∏–∑ –∫–æ–ª—å—á—É–≥–∏', 'armor', 'legs', 'common', 1,
    0, 0, 0, 0, 0, 0, 2, 1, 5, 0, 0, 10, 100, 1, 'üëñ'),

('–ö–æ–ª—å—á—É–∂–Ω—ã–µ —Å–∞–ø–æ–≥–∏', '–¢—è–∂–µ–ª—ã–µ —Å–∞–ø–æ–≥–∏ –∏–∑ –∫–æ–ª—å—á—É–≥–∏', 'armor', 'boots', 'common', 1,
    0, 0, 0, 0, 0, 0, 1, 1, 3, 0, 0, 6, 70, 1, 'ü•æ'),

-- ============================================
-- –ê–ö–°–ï–°–°–£–ê–†–´
-- ============================================
('–ö–æ–ª—å—Ü–æ —Å–∏–ª—ã', '–ö–æ–ª—å—Ü–æ, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–µ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å–∏–ª—É', 'accessory', 'ring', 'uncommon', 5,
    0, 0, 0, 0, 0, 0, 3, 2, 1, 0, 0, 0, 200, 1, 'üíç'),

('–ê–º—É–ª–µ—Ç –ª–æ–≤–∫–æ—Å—Ç–∏', '–ê–º—É–ª–µ—Ç, –ø–æ–≤—ã—à–∞—é—â–∏–π –ª–æ–≤–∫–æ—Å—Ç—å', 'accessory', 'amulet', 'uncommon', 8,
    4, 2, 2, 0, 0, 0, 0, 0, 0, 1, 0, 0, 250, 1, 'üîÆ'),

('–ë—Ä–∞—Å–ª–µ—Ç –º–∞–≥–∏–∏', '–ë—Ä–∞—Å–ª–µ—Ç, —É—Å–∏–ª–∏–≤–∞—é—â–∏–π –º–∞–≥–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏', 'accessory', 'bracelet', 'uncommon', 10,
    0, 1, 1, 3, 2, 3, 0, 0, 0, 0, 0, 0, 300, 1, 'üìø'),

-- ============================================
-- –ó–ï–õ–¨–Ø –ò –ü–†–ï–î–ú–ï–¢–´
-- ============================================
('–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 100 –∑–¥–æ—Ä–æ–≤—å—è', 'consumable', NULL, 'common', 1,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20, 50, 'üß™'),

('–ó–µ–ª—å–µ –º–∞–Ω—ã', '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 50 –º–∞–Ω—ã', 'consumable', NULL, 'common', 1,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 50, 'üíô'),

('–°–≤–∏—Ç–æ–∫ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞', '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤ –≥–æ—Ä–æ–¥', 'consumable', NULL, 'uncommon', 5,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 10, 'üìú'),

-- ============================================
-- –ú–ê–¢–ï–†–ò–ê–õ–´
-- ============================================
('–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞', '–ë–∞–∑–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞', 'material', NULL, 'common', 1,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 100, '‚õèÔ∏è'),

('–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å', '–†–µ–¥–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π', 'material', NULL, 'rare', 20,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 200, 20, 'üíé'),

('–°—É—â–Ω–æ—Å—Ç—å —Ç—å–º—ã', '–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª —Ç–µ–º–Ω–æ–π –º–∞–≥–∏–∏', 'material', NULL, 'epic', 50,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1000, 5, 'üåë');

-- ============================================
-- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ê–°–ß–ï–¢–ê –°–¢–ê–¢–û–í –û–¢ –ü–†–ï–î–ú–ï–¢–û–í
-- ============================================
CREATE OR REPLACE FUNCTION get_equipment_bonuses(p_character_id UUID)
RETURNS JSON AS $$
DECLARE
    v_result JSON;
BEGIN
    SELECT json_build_object(
        'agility', COALESCE(SUM(i.agility_bonus), 0),
        'precision', COALESCE(SUM(i.precision_bonus), 0),
        'evasion', COALESCE(SUM(i.evasion_bonus), 0),
        'intelligence', COALESCE(SUM(i.intelligence_bonus), 0),
        'spell_power', COALESCE(SUM(i.spell_power_bonus), 0),
        'resistance', COALESCE(SUM(i.resistance_bonus), 0),
        'strength', COALESCE(SUM(i.strength_bonus), 0),
        'endurance', COALESCE(SUM(i.endurance_bonus), 0),
        'armor', COALESCE(SUM(i.armor_bonus), 0),
        'stealth', COALESCE(SUM(i.stealth_bonus), 0),
        'attack_damage', COALESCE(SUM(i.attack_damage), 0),
        'defense', COALESCE(SUM(i.defense), 0)
    ) INTO v_result
    FROM character_equipment ce
    JOIN items i ON ce.item_id = i.id
    WHERE ce.character_id = p_character_id;
    
    RETURN COALESCE(v_result, '{}'::json);
END;
$$ LANGUAGE plpgsql;
